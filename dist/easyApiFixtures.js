'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}require('babel-polyfill'),require('babel-core/register');var _path=require('path'),axios=require('axios'),sanitize=require('sanitize-filename'),appRootDir=require('app-root-dir').get(),_=require('lodash'),_require=require('lodash'),flatMap=_require.flatMap,fs=require('fs'),mkdirp=require('mkdirp'),easyApiFixtures=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:_path.join(appRootDir,'fixtures.config.js');_classCallCheck(this,a),this.appRootDir=appRootDir,this.defaults={output:{filename:'[name].json',uglified:!1,versionInPath:!0,endpointInPath:!0,aliasInPath:!0}},this.config=this.parseConfig(this.constructor.loadFile(b))}return _createClass(a,[{key:'parseConfig',value:function parseConfig(a){var b=a;b.output=Object.assign({},this.defaults.output,a.output);var c=flatMap([b.api]),d=c.map(function(a){return Object.assign({},a,{alias:sanitize(a.alias||a.url),fixture:flatMap([a.fixture]).map(function(a){return Object.assign({},a,{slug:flatMap([a.slug]),endpoint:flatMap([a.endpoint])})})})});return Object.assign({},b,{api:d})}},{key:'getBasePath',value:function getBasePath(a){var b=this.config.output;return _path.join(this.appRootDir,b.path,b.aliasInPath?_.get(a,'alias',''):'',b.versionInPath?_.get(a,'version',''):'')}},{key:'getConfig',value:function getConfig(){return this.config}},{key:'getFileName',value:function getFileName(a){var b=this.config.output.filename.replace('[name]',a);return b}},{key:'request',value:function request(a){var b=/.*:\/\/.*?(?=\/)|\[mock\]/gm,c=a.match(b)[0],d=a.split(b)[1],e=this.config.output.endpointInPath,f=d.split('/').filter(function(b){return b}),g=_path.join(this.getBasePath(this.config.api.filter(function(a){return a.url.includes(c)})[0]),e?f[0]:'',this.getFileName(f[1]));return this.constructor.loadFile(g)}},{key:'loadData',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,Promise.all(this.config.api.map(function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(c){var d;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.getBasePath(c),a.t0=d,a.next=4,b.constructor.getFixturesDataFromApi(c);case 4:return a.t1=a.sent,a.abrupt('return',{fixturePath:a.t0,fixtures:a.t1});case 6:case'end':return a.stop();}},a,b)}));return function(){return a.apply(this,arguments)}}()));case 2:this.fixtureData=a.sent;case 3:case'end':return a.stop();}},a,this)}));return function loadData(){return a.apply(this,arguments)}}()},{key:'writeFile',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d=b.fixturePath,e=b.slug,f=b.endpoint,g=b.data;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.constructor.ensureDirectoryExistence(_path.join(d,f));case 2:c=_path.join(d,f,this.getFileName(e)),fs.writeFile(c,JSON.stringify(g,null,2),function(a){return a?void console.error(a):void console.log('\x1B[32m',c,'has been created','\x1B[0m')});case 4:case'end':return a.stop();}},a,this)}));return function writeFile(){return a.apply(this,arguments)}}()},{key:'run',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.loadData();case 2:this.fixtureData.forEach(function(a){var c=a.fixturePath;a.fixtures.forEach(function(a){b.writeFile(_extends({fixturePath:c},a))})});case 3:case'end':return a.stop();}},a,this)}));return function run(){return a.apply(this,arguments)}}()}],[{key:'loadFile',value:function loadFile(a){try{var b=require(a);return b}catch(a){throw a}}},{key:'getFixturesDataFromApi',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:axios.get;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=function(a,b,c){return e(a+'/'+b+'/'+c).then(function(a){return{slug:c,endpoint:b,data:a.data}}).catch(function(a){return console.log(a)})},a.next=3,Promise.all(_.flatMap(b.fixture,function(a){var d=b.url;return _.flatMap(a.endpoint,function(b){return _.map(a.slug,function(a){return c(d,b,a)})})}));case 3:return d=a.sent,a.abrupt('return',d);case 5:case'end':return a.stop();}},a,this)}));return function getFixturesDataFromApi(){return a.apply(this,arguments)}}()},{key:'ensureDirectoryExistence',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:fs.existsSync(b)||mkdirp.sync(b);case 1:case'end':return a.stop();}},a,this)}));return function ensureDirectoryExistence(){return a.apply(this,arguments)}}()}]),a}();module.exports=easyApiFixtures;